# Сервис валидации фотографий

Сервис для автоматической проверки фотографий на соответствие требованиям. Позволяет загружать фотографии, анализировать их и получать детальный отчет о результатах проверки.

## Возможности

Сервис выполняет следующие проверки фотографий:
- Проверка формата и размера файла
- Проверка размеров изображения
- Проверка цветности (не черно-белое)
- Детекция лиц и их количества
- Проверка положения и размера лица
- Проверка позы лица (анфас)
- Анализ размытости изображения
- Проверка на эффект красных глаз
- Анализ фона изображения
- Детекция посторонних объектов и людей
- Проверка на наличие аксессуаров
- Анализ освещения

## Требования

- Docker и Docker Compose
- Python 3.9+ (для запуска тестовых скриптов)
- Минимум 2 ГБ свободной оперативной памяти
- Минимум 1 ГБ свободного места на диске

## Установка и запуск

### Клонирование репозитория

```bash
git clone https://github.com/borzov/photo-validation-service.git
cd photo-validation-service
```

### Запуск с помощью Docker Compose

```bash
docker-compose up -d
```

Сервис будет доступен по адресу: http://localhost:8000

### Остановка сервиса

```bash
docker-compose down
```

## API

### Загрузка фотографии на валидацию

**Запрос**:
```
POST /api/v1/validate
Content-Type: multipart/form-data

file: [файл изображения]
```

**Ответ**:
```json
{
  "requestId": "6b5f0176-3092-4554-afbe-83533e22d7b6"
}
```

### Получение результатов валидации

**Запрос**:
```
GET /api/v1/results/{requestId}
```

**Ответ**:
```json
{
  "requestId": "6b5f0176-3092-4554-afbe-83533e22d7b6",
  "status": "COMPLETED",
  "overallStatus": "APPROVED",
  "createdAt": "2025-04-30T18:26:50.018000",
  "processedAt": "2025-04-30T18:26:50.078000",
  "processingTime": 0.058,
  "checks": [
    {
      "check": "fileFormat",
      "status": "PASSED",
      "details": "jpeg"
    },
    {
      "check": "fileSize",
      "status": "PASSED",
      "details": "120KB"
    },
    // ... другие проверки
  ]
}
```

### Статусы проверок

Каждая проверка может иметь один из следующих статусов:
- `PASSED` - проверка пройдена успешно
- `FAILED` - проверка не пройдена
- `NEEDS_REVIEW` - требуется ручная проверка

Общий статус валидации может быть:
- `APPROVED` - фотография соответствует всем требованиям
- `REJECTED` - фотография не соответствует требованиям
- `MANUAL_REVIEW` - требуется ручная проверка

Статус обработки запроса может быть:
- `PENDING` - запрос создан, но обработка еще не началась
- `PROCESSING` - запрос обрабатывается
- `COMPLETED` - обработка завершена
- `FAILED` - произошла ошибка при обработке

## Тестирование

В директории `tests/scripts` находится скрипт для тестирования сервиса:

```bash
cd tests/scripts
python check_photos.py --api-url http://localhost:8000 --photo-dir ../photos --report-dir ../reports
```

Параметры скрипта:
- `--api-url` - URL API сервиса (по умолчанию: http://localhost:8000)
- `--photo-dir` - директория с фотографиями для проверки (по умолчанию: ../photos)
- `--report-dir` - директория для сохранения отчетов (по умолчанию: ../reports)
- `--max-attempts` - максимальное количество попыток получения результата (по умолчанию: 60)
- `--delay` - задержка между попытками в секундах (по умолчанию: 5)

## Разработка

### Структура проекта

```
photo-validation-service/
├── app/                      # Код приложения
│   ├── api/                  # API-эндпоинты
│   ├── core/                 # Базовые настройки и утилиты
│   ├── cv/                   # Модули компьютерного зрения
│   ├── db/                   # Работа с базой данных
│   └── storage/              # Работа с хранилищем файлов
├── migrations/               # Миграции базы данных
├── tests/                    # Тесты и скрипты для тестирования
│   ├── photos/               # Тестовые фотографии
│   ├── reports/              # Отчеты о тестировании
│   └── scripts/              # Скрипты для тестирования
├── Dockerfile                # Файл для сборки Docker-образа
├── docker-compose.yml        # Конфигурация Docker Compose
├── requirements.txt          # Зависимости Python
└── README.md                 # Документация
```

### База данных

Сервис использует PostgreSQL для хранения данных. Схема базы данных создается автоматически при первом запуске с помощью миграций Alembic.

Для подключения к базе данных можно использовать:
```
Host: localhost
Port: 5432
Database: photo_validation
Username: postgres
Password: postgres
```

### Локальное хранилище

Загруженные фотографии временно сохраняются в директории `local_storage` и удаляются после обработки.

## Производительность

Сервис обрабатывает одну фотографию в среднем за 0.5-2 секунды, в зависимости от сложности изображения и нагрузки на систему. Информация о времени обработки каждой фотографии сохраняется в базе данных и возвращается в ответе API.

## Лицензия

MIT