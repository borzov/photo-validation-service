{% extends "base.html" %}

{% block content %}
<div class="mb-6">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                <i data-lucide="activity" class="h-8 w-8 mr-3 text-blue-600"></i>
                Мониторинг операций
            </h1>
            <p class="text-gray-600 mt-2">Отслеживание и анализ операций валидации</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="refreshData()" class="btn-secondary">
                <i data-lucide="refresh-cw" class="h-4 w-4"></i>
                Обновить
            </button>
            <button onclick="exportReport()" class="btn-primary">
                <i data-lucide="download" class="h-4 w-4"></i>
                Экспорт отчета
            </button>
        </div>
    </div>
</div>

<!-- Карточки состояния системы -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="metric-card">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-white/80">Всего операций</p>
                <p class="text-3xl font-bold text-white" id="totalOperations">{{ total_operations|default('0') }}</p>
            </div>
            <i data-lucide="hash" class="h-8 w-8 text-white/60"></i>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-white/80">Успешных</p>
                <p class="text-3xl font-bold text-white" id="successfulOperations">{{ successful_operations|default('0') }}</p>
            </div>
            <i data-lucide="check-circle" class="h-8 w-8 text-white/60"></i>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-white/80">Неудачных</p>
                <p class="text-3xl font-bold text-white" id="failedOperations">{{ failed_operations|default('0') }}</p>
            </div>
            <i data-lucide="x-circle" class="h-8 w-8 text-white/60"></i>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-white/80">Среднее время (с)</p>
                <p class="text-3xl font-bold text-white" id="avgProcessingTime">{{ avg_processing_time|default('0.0') }}</p>
            </div>
            <i data-lucide="clock" class="h-8 w-8 text-white/60"></i>
        </div>
    </div>
</div>

<!-- Графики и аналитика -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- График времени обработки -->
    <div class="card p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i data-lucide="trending-up" class="h-5 w-5 mr-2 text-blue-600"></i>
            График времени обработки
        </h3>
        <canvas id="processingTimeChart" width="400" height="200"></canvas>
    </div>
    
    <!-- Success Rate Chart -->
    <div class="card p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i data-lucide="pie-chart" class="h-5 w-5 mr-2 text-green-600"></i>
            Статистика результатов
        </h3>
        <canvas id="successRateChart" width="400" height="200"></canvas>
    </div>
</div>

<!-- System Performance -->
<div class="card p-6 mb-8">
    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
        <i data-lucide="cpu" class="h-5 w-5 mr-2 text-purple-600"></i>
        Производительность системы
    </h3>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-gray-700">Использование CPU</span>
                <span class="text-sm text-gray-600" id="cpuUsage">{{ cpu_usage|default('0.0') }}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-blue-600 h-2 rounded-full" style="width: {{ cpu_usage|default(0) }}%"></div>
            </div>
        </div>
        
        <div>
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-gray-700">Использование памяти</span>
                <span class="text-sm text-gray-600" id="memoryUsage">{{ memory_usage|default('0.0') }}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-green-600 h-2 rounded-full" style="width: {{ memory_usage|default(0) }}%"></div>
            </div>
        </div>
        
        <div>
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-gray-700">Кэш попаданий</span>
                <span class="text-sm text-gray-600" id="cacheHitRate">{{ cache_hit_rate|default('0.0') }}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-purple-600 h-2 rounded-full" style="width: {{ cache_hit_rate|default(0) }}%"></div>
            </div>
        </div>
    </div>
</div>

<!-- Validation History -->
<div class="card p-6">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900 flex items-center">
            <i data-lucide="history" class="h-5 w-5 mr-2 text-gray-600"></i>
            История валидации
        </h3>
        <div class="flex space-x-2">
            <select id="historyFilter" class="form-input">
                <option value="all">Все результаты</option>
                <option value="APPROVED">Одобренные</option>
                <option value="REJECTED">Отклоненные</option>
                <option value="MANUAL_REVIEW">Требуют проверки</option>
            </select>
            <select id="timeRange" class="form-input">
                <option value="1h">Последний час</option>
                <option value="24h" selected>Последние 24 часа</option>
                <option value="7d">Последние 7 дней</option>
                <option value="30d">Последние 30 дней</option>
            </select>
        </div>
    </div>
    
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Время</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Файл</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Результат</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Проверки</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Время обработки</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                </tr>
            </thead>
            <tbody id="validationHistory" class="bg-white divide-y divide-gray-200">
                <!-- Dynamic content will be inserted here -->
            </tbody>
        </table>
    </div>
    
    <div class="flex items-center justify-between mt-4">
        <p class="text-sm text-gray-700">
            Показано <span id="showingCount">0</span> из <span id="totalCount">0</span> записей
        </p>
        <div class="flex space-x-2">
            <button onclick="loadPreviousPage()" class="btn-secondary" id="prevButton" disabled>
                <i data-lucide="chevron-left" class="h-4 w-4 mr-1"></i>
                Предыдущая
            </button>
            <button onclick="loadNextPage()" class="btn-secondary" id="nextButton">
                Следующая
                <i data-lucide="chevron-right" class="h-4 w-4 ml-1"></i>
            </button>
        </div>
    </div>
</div>

<!-- Check Details Modal -->
<div id="checkDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Детали проверки</h3>
                    <button onclick="closeCheckDetails()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
                <div id="checkDetailsContent">
                    <!-- Dynamic content will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let currentPage = 1;
    let currentFilter = 'all';
    let currentTimeRange = '24h';
    let refreshInterval;
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        initializeCharts();
        loadValidationHistory();
        startRealTimeUpdates();
        
        // Setup event listeners
        document.getElementById('historyFilter').addEventListener('change', function() {
            currentFilter = this.value;
            currentPage = 1;
            loadValidationHistory();
        });
        
        document.getElementById('timeRange').addEventListener('change', function() {
            currentTimeRange = this.value;
            currentPage = 1;
            loadValidationHistory();
        });
    });
    
    // Real-time updates
    function startRealTimeUpdates() {
        updateCurrentOperations();
        updateSystemMetrics();
        
        // Update every 5 seconds
        refreshInterval = setInterval(() => {
            updateCurrentOperations();
            updateSystemMetrics();
        }, 5000);
    }
    
    function updateCurrentOperations() {
        fetch('/admin/api/operations/current')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('currentOperations');
                
                if (data.operations && data.operations.length > 0) {
                    container.innerHTML = data.operations.map(op => `
                        <div class="bg-gray-50 rounded-lg p-4 mb-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="flex-shrink-0">
                                        <div class="h-8 w-8 bg-blue-100 rounded-full flex items-center justify-center">
                                            <i data-lucide="image" class="h-4 w-4 text-blue-600"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">${op.filename}</p>
                                        <p class="text-sm text-gray-500">ID: ${op.operation_id}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <div class="text-right">
                                        <p class="text-sm font-medium text-gray-900">Этап: ${op.current_stage}</p>
                                        <p class="text-sm text-gray-500">Прогресс: ${op.progress}%</p>
                                    </div>
                                    <div class="w-20">
                                        <div class="bg-gray-200 rounded-full h-2">
                                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                                 style="width: ${op.progress}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i data-lucide="clock" class="h-12 w-12 mx-auto mb-3 text-gray-300"></i>
                            <p>Нет активных операций</p>
                        </div>
                    `;
                }
                
                lucide.createIcons();
            })
            .catch(error => console.error('Error updating operations:', error));
    }
    
    function updateSystemMetrics() {
        fetch('/admin/api/metrics')
            .then(response => response.json())
            .then(data => {
                document.getElementById('activeOperations').textContent = data.active_operations || 0;
                document.getElementById('successfulToday').textContent = data.successful_today || 0;
                document.getElementById('rejectedToday').textContent = data.rejected_today || 0;
                document.getElementById('avgProcessingTime').textContent = (data.avg_processing_time || 0).toFixed(1);
                
                document.getElementById('cpuUsage').textContent = (data.cpu_usage || 0).toFixed(1) + '%';
                document.getElementById('memoryUsage').textContent = (data.memory_usage || 0).toFixed(1) + '%';
                document.getElementById('cacheHitRate').textContent = (data.cache_hit_rate || 0).toFixed(1) + '%';
                
                // Update progress bars
                document.querySelector('[style*="width:"][style*="cpu"]')?.style?.setProperty('width', (data.cpu_usage || 0) + '%');
                document.querySelector('[style*="width:"][style*="memory"]')?.style?.setProperty('width', (data.memory_usage || 0) + '%');
                document.querySelector('[style*="width:"][style*="cache"]')?.style?.setProperty('width', (data.cache_hit_rate || 0) + '%');
            })
            .catch(error => console.error('Error updating metrics:', error));
    }
    
    function loadValidationHistory() {
        const params = new URLSearchParams({
            page: currentPage,
            filter: currentFilter,
            time_range: currentTimeRange,
            limit: 20
        });
        
        fetch(`/admin/api/validation/history?${params}`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('validationHistory');
                
                tbody.innerHTML = data.items.map(item => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${new Date(item.created_at).toLocaleString('ru')}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i data-lucide="image" class="h-4 w-4 text-gray-400 mr-2"></i>
                                <span class="text-sm text-gray-900">${item.filename}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(item.status)}">
                                ${getStatusText(item.status)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${item.checks_passed}/${item.total_checks}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${(item.processing_time || 0).toFixed(2)}с
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="showCheckDetails('${item.id}')" 
                                    class="text-blue-600 hover:text-blue-900 mr-3">
                                Детали
                            </button>
                            ${item.image_path ? `<button onclick="viewImage('${item.image_path}')" 
                                                        class="text-green-600 hover:text-green-900">
                                Просмотр
                            </button>` : ''}
                        </td>
                    </tr>
                `).join('');
                
                document.getElementById('showingCount').textContent = data.items.length;
                document.getElementById('totalCount').textContent = data.total;
                
                // Update pagination buttons
                document.getElementById('prevButton').disabled = currentPage <= 1;
                document.getElementById('nextButton').disabled = currentPage >= Math.ceil(data.total / 20);
                
                lucide.createIcons();
            })
            .catch(error => console.error('Error loading history:', error));
    }
    
    function getStatusColor(status) {
        switch (status) {
            case 'APPROVED': return 'bg-green-100 text-green-800';
            case 'REJECTED': return 'bg-red-100 text-red-800';
            case 'MANUAL_REVIEW': return 'bg-yellow-100 text-yellow-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }
    
    function getStatusText(status) {
        switch (status) {
            case 'APPROVED': return 'Одобрено';
            case 'REJECTED': return 'Отклонено';
            case 'MANUAL_REVIEW': return 'Требует проверки';
            default: return status;
        }
    }
    
    function showCheckDetails(validationId) {
        fetch(`/admin/api/validation/${validationId}/details`)
            .then(response => response.json())
            .then(data => {
                const content = document.getElementById('checkDetailsContent');
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold text-gray-900">Основная информация</h4>
                                <dl class="mt-2 space-y-1">
                                    <div class="flex justify-between">
                                        <dt class="text-sm text-gray-500">Файл:</dt>
                                        <dd class="text-sm text-gray-900">${data.filename}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-sm text-gray-500">Размер:</dt>
                                        <dd class="text-sm text-gray-900">${data.file_size} bytes</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-sm text-gray-500">Время обработки:</dt>
                                        <dd class="text-sm text-gray-900">${data.processing_time}с</dd>
                                    </div>
                                </dl>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900">Результат</h4>
                                <dl class="mt-2 space-y-1">
                                    <div class="flex justify-between">
                                        <dt class="text-sm text-gray-500">Статус:</dt>
                                        <dd class="text-sm">
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(data.status)}">
                                                ${getStatusText(data.status)}
                                            </span>
                                        </dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-sm text-gray-500">Проверки:</dt>
                                        <dd class="text-sm text-gray-900">${data.checks_passed}/${data.total_checks} пройдено</dd>
                                    </div>
                                </dl>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-3">Детали проверок</h4>
                            <div class="space-y-2">
                                ${data.check_results.map(check => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div class="flex items-center space-x-3">
                                            <div class="h-6 w-6 rounded-full flex items-center justify-center ${
                                                check.status === 'PASSED' ? 'bg-green-100' : 
                                                check.status === 'FAILED' ? 'bg-red-100' : 'bg-yellow-100'
                                            }">
                                                <i data-lucide="${
                                                    check.status === 'PASSED' ? 'check' : 
                                                    check.status === 'FAILED' ? 'x' : 'alert-circle'
                                                }" class="h-4 w-4 ${
                                                    check.status === 'PASSED' ? 'text-green-600' : 
                                                    check.status === 'FAILED' ? 'text-red-600' : 'text-yellow-600'
                                                }"></i>
                                            </div>
                                            <div>
                                                <p class="text-sm font-medium text-gray-900">${check.name}</p>
                                                <p class="text-xs text-gray-500">${check.check_id}</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-sm text-gray-900">${check.status}</p>
                                            ${check.message ? `<p class="text-xs text-gray-500">${check.message}</p>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('checkDetailsModal').classList.remove('hidden');
                lucide.createIcons();
            })
            .catch(error => console.error('Error loading check details:', error));
    }
    
    function closeCheckDetails() {
        document.getElementById('checkDetailsModal').classList.add('hidden');
    }
    
    function loadPreviousPage() {
        if (currentPage > 1) {
            currentPage--;
            loadValidationHistory();
        }
    }
    
    function loadNextPage() {
        currentPage++;
        loadValidationHistory();
    }
    
    function refreshData() {
        updateCurrentOperations();
        updateSystemMetrics();
        loadValidationHistory();
        updateCharts();
    }
    
    function exportReport() {
        const params = new URLSearchParams({
            filter: currentFilter,
            time_range: currentTimeRange
        });
        
        window.open(`/admin/api/reports/export?${params}`, '_blank');
    }
    
    function initializeCharts() {
        // Processing Time Chart
        const processingTimeCtx = document.getElementById('processingTimeChart').getContext('2d');
        window.processingTimeChart = new Chart(processingTimeCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Среднее время обработки (сек)',
                    data: [],
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Секунды'
                        }
                    }
                }
            }
        });
        
        // Success Rate Chart
        const successRateCtx = document.getElementById('successRateChart').getContext('2d');
        window.successRateChart = new Chart(successRateCtx, {
            type: 'doughnut',
            data: {
                labels: ['Одобрено', 'Отклонено', 'Требует проверки'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: [
                        'rgb(34, 197, 94)',
                        'rgb(239, 68, 68)',
                        'rgb(245, 158, 11)'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        updateCharts();
    }
    
    function updateCharts() {
        // Load processing time data
        fetch('/admin/api/metrics/processing-time')
            .then(response => response.json())
            .then(data => {
                window.processingTimeChart.data.labels = data.labels;
                window.processingTimeChart.data.datasets[0].data = data.values;
                window.processingTimeChart.update();
            });
        
        // Load success rate data
        fetch('/admin/api/metrics/success-rate')
            .then(response => response.json())
            .then(data => {
                window.successRateChart.data.datasets[0].data = [
                    data.approved || 0,
                    data.rejected || 0,
                    data.manual_review || 0
                ];
                window.successRateChart.update();
            });
    }
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });
</script>
{% endblock %} 